<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Check List Bienestar Animal - Kosher</title>

  <style>
    :root{
      --bg:#f3f5f7; --card:#ffffff; --text:#111827; --muted:#6b7280;
      --accent:#2563eb; --border:#e5e7eb; --danger:#dc2626;
    }
    body{ margin:0; background:var(--bg); color:var(--text); font-family: Arial, sans-serif; padding:12px; }
    .wrap{ max-width: 1100px; margin:0 auto; }

    .encabezado table{ width:100%; border-collapse: collapse; background:#fff; }
    .encabezado td{ border:2px solid #000; padding:8px; vertical-align:middle; }
    .encabezado .logo{ width:20%; text-align:center; }
    .encabezado .logo img{ width:110px; max-width:100%; height:auto; }
    .encabezado .titulo{ width:60%; text-align:center; font-size:13px; line-height:1.25; }
    .encabezado .info{ width:20%; text-align:center; font-size:12px; background:#dff3ff; line-height:1.25; }

    .tabs{ display:flex; gap:8px; margin:10px 0; }
    .tab-btn{
      flex:1; padding:12px; border:none; border-radius:10px; cursor:pointer;
      background:#cbd5e1; font-weight:700; color:#334155;
    }
    .tab-btn.active{ background:var(--accent); color:#fff; }
    .tab-content{ display:none; }
    .tab-content.active{ display:block; }

    .toolbar{
      display:flex; gap:8px; flex-wrap:wrap;
      background:var(--card); border:1px solid var(--border);
      border-radius:14px; padding:10px; margin-bottom:10px;
    }
    .toolbar button{
      flex:1; min-width:140px; height:52px; cursor:pointer; border:none;
      border-radius:12px; background:var(--accent); color:#fff;
      font-weight:800;
    }
    .toolbar button.secondary{ background:#475569; }
    .toolbar button.danger{ background:var(--danger); }
    .toolbar .hint{ flex: 2; min-width: 220px; display:flex; align-items:center; color:var(--muted); font-size:12px; }

    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:16px; padding:12px; margin-bottom:10px;
    }
    .grid{
      display:grid; grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns: repeat(2, 1fr); }
    }
    .row{ display:flex; flex-direction:column; gap:6px; }
    label{ font-size:11px; font-weight:800; color:var(--muted); text-transform:uppercase; }
    input, select, textarea{
      border:1px solid var(--border); background:var(--bg); color:var(--text);
      border-radius:10px; padding:10px; font-size:15px; outline:none;
    }
    textarea{ min-height:72px; resize:vertical; }

    .table-wrap{ background:var(--card); border:1px solid var(--border); border-radius:16px; overflow:auto; }
    table{ width:100%; border-collapse: collapse; }
    th, td{ border-bottom:1px solid var(--border); padding:10px; text-align:left; font-size:14px; }
    th{ background:#f1f5f9; position: sticky; top:0; z-index:1; }

    .pill-nc{ color:#fff; background:var(--danger); padding:2px 8px; border-radius:999px; font-size:12px; font-weight:800; }
    .pill-a{ color:#fff; background:#16a34a; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:800; }
    .pill-na{ color:#0f172a; background:#e2e8f0; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:800; }

    .mini-btn{
      border:none; border-radius:10px; padding:8px 10px; cursor:pointer;
      font-weight:800;
    }
    .mini-btn.primary{ background:var(--accent); color:#fff; }
    .mini-btn.gray{ background:#e2e8f0; color:#0f172a; }
    .mini-btn.danger{ background:var(--danger); color:#fff; }

    .nc-box{
      margin-top:10px; border:1px dashed #fca5a5; background:#fff1f2;
      border-radius:14px; padding:10px;
    }
    .nc-title{ font-weight:900; color:#7f1d1d; margin-bottom:8px; }

    @media print{
      body{ background:#fff; padding:0; }
      .tabs, .toolbar{ display:none !important; }
      .card, .table-wrap{ border:none; }
      th{ position:static; }
      .no-print{ display:none !important; }
      .print-page{ page-break-after: always; padding: 8mm; }
      .print-page:last-child{ page-break-after: auto; }
      .sign{ margin-top:16px; display:flex; justify-content:space-between; gap:18px; }
      .line{ flex:1; border-top: 2px solid #000; padding-top:6px; text-align:center; font-weight:800; }
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="encabezado">
    <table>
      <tr>
        <td class="logo">
          <img src="logo.jpg"
               onerror="this.onerror=null; this.src='logo.png';"
               alt="Logo">
        </td>
        <td class="titulo">
          <div><strong>CHECK LIST</strong></div>
          <div><strong>BIENESTAR ANIMAL EN FAENA KOSHER</strong></div>
          <div><strong>ISRAEL</strong></div>
          <div style="margin-top:4px; color:#0b3d91; font-weight:900;">
            Circular 4170 A &nbsp; | &nbsp; R-BA-001-6
          </div>
        </td>
        <td class="info">
          Emisión: Junio / 2024<br>
          Rev: 03
        </td>
      </tr>
    </table>
  </div>

  <div class="tabs">
    <button class="tab-btn active" onclick="openTab(event,'tab-reg')">REGISTRO</button>
    <button class="tab-btn" onclick="openTab(event,'tab-days')">DÍAS FINALIZADOS</button>
  </div>

  <div id="tab-reg" class="tab-content active">

    <div class="toolbar">
      <button onclick="nuevoDia()">NUEVO DÍA</button>
      <button class="secondary" onclick="imprimirDiaActual()">PDF / IMPRIMIR</button>
      <button onclick="finalizarDia()">FINALIZAR DÍA</button>
      <button class="danger" onclick="borrarDiaActual()">BORRAR DÍA</button>
      <div class="hint">
        P1: contención→degüello (≤10s) · P2: liberación sujeción post degüello · FA: falso aneurisma · P3: liberar del cajón (≥30s)
      </div>
    </div>

    <div class="card">
      <div class="grid">
        <div class="row">
          <label>Fecha de faena</label>
          <input type="date" id="in-fecha" />
        </div>
        <div class="row">
          <label>Animales a revisar</label>
          <input type="text" id="in-animales" value="Todos los animales que integran la faena Kosher del día" />
        </div>
        <div class="row">
          <label>Responsable (iniciales)</label>
          <input type="text" id="in-resp" maxlength="4" placeholder="Ej: YA"
                 oninput="this.value=this.value.toUpperCase().replace(/[^A-Z]/g,'')" />
        </div>
        <div class="row">
          <label>Observaciones generales</label>
          <input type="text" id="in-obs" placeholder="Opcional"/>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="grid">
        <div class="row">
          <label>Garrón</label>
          <input type="number" id="in-garron" placeholder="Ej: 51" />
        </div>

        <!-- ✅ ahora arrancan sin seleccionar -->
        <div class="row">
          <label>P1</label>
          <select id="in-p1">
            <option value="">—</option>
            <option value="A">A (Aceptable)</option>
            <option value="NC">NC (No conforme)</option>
          </select>
        </div>
        <div class="row">
          <label>P2</label>
          <select id="in-p2">
            <option value="">—</option>
            <option value="A">A (Aceptable)</option>
            <option value="NC">NC (No conforme)</option>
          </select>
        </div>
        <div class="row">
          <label>FA</label>
          <select id="in-fa">
            <option value="">—</option>
            <option value="A">A (Aceptable)</option>
            <option value="NC">NC (No conforme)</option>
          </select>
        </div>
        <div class="row">
          <label>P3</label>
          <select id="in-p3">
            <option value="">—</option>
            <option value="A">A (Aceptable)</option>
            <option value="NC">NC (No conforme)</option>
          </select>
        </div>

        <div class="row" style="grid-column: span 3;">
          <label>Tolerancia cero</label>
          <input type="text" value="IZADO DE ANIMALES CON SENSIBILIDAD" readonly />
        </div>
      </div>

      <div class="no-print" style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
        <button class="mini-btn primary" onclick="agregarRegistro()">AGREGAR</button>
        <button class="mini-btn gray" onclick="limpiarCarga()">LIMPIAR</button>
      </div>

      <div id="nc-panel" class="nc-box" style="display:none;">
        <div class="nc-title">NC DETECTADA (completar)</div>
        <div class="grid" style="grid-template-columns: 1fr 1fr;">
          <div class="row">
            <label>No conformidad</label>
            <textarea id="in-nc"></textarea>
          </div>
          <div class="row">
            <label>Acción correctiva</label>
            <textarea id="in-ac"></textarea>
          </div>
          <div class="row">
            <label>Acción preventiva</label>
            <textarea id="in-ap"></textarea>
          </div>
          <div class="row">
            <label>Encargado / Responsable</label>
            <input type="text" id="in-enc" placeholder="Nombre o iniciales" />
          </div>
        </div>
      </div>

    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Garrón</th>
            <th>P1</th>
            <th>P2</th>
            <th>FA</th>
            <th>P3</th>
            <th class="no-print">Acciones</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="card" style="margin-top:10px;">
      <div style="font-weight:900; margin-bottom:6px;">Referencias</div>
      <div style="color:var(--muted); font-size:13px; line-height:1.35;">
        A = Aceptable · NC = No Conforme<br>
        P1: Tiempo desde contención al degüello (hasta 10 segundos)<br>
        P2: Liberación de accionamientos de sujeción del cajón post degüello<br>
        FA: Falso aneurisma<br>
        P3: Liberación del animal de cajón rotatorio (mínimo 30 segundos)
      </div>
    </div>

  </div>

  <!-- TAB DÍAS FINALIZADOS -->
  <div id="tab-days" class="tab-content">
    <div class="card">
      <div style="font-weight:900; margin-bottom:6px;">Días guardados</div>
      <div style="color:var(--muted); font-size:13px;">
        Acá quedan los días “finalizados”. Podés reabrir para corregir o imprimir en PDF.
      </div>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Registros</th>
            <th>Responsable</th>
            <th>Obs</th>
            <th class="no-print">Acciones</th>
          </tr>
        </thead>
        <tbody id="daysBody"></tbody>
      </table>
    </div>
  </div>

</div>

<script>
  const LS_DAYS = "ba_kosher_days_v2";
  const LS_CURR = "ba_kosher_current_v2";

  let current = null;

  function uid(){
    return "D" + Date.now().toString(36) + Math.random().toString(36).slice(2,7);
  }

  function loadDays(){
    try{ return JSON.parse(localStorage.getItem(LS_DAYS) || "[]"); }
    catch(e){ return []; }
  }
  function saveDays(days){
    localStorage.setItem(LS_DAYS, JSON.stringify(days));
  }

  function saveCurrent(){
    localStorage.setItem(LS_CURR, JSON.stringify(current));
  }
  function loadCurrent(){
    try{
      const v = localStorage.getItem(LS_CURR);
      return v ? JSON.parse(v) : null;
    }catch(e){ return null; }
  }

  function openTab(evt, id){
    document.querySelectorAll(".tab-content").forEach(x => x.classList.remove("active"));
    document.querySelectorAll(".tab-btn").forEach(x => x.classList.remove("active"));
    document.getElementById(id).classList.add("active");
    evt.currentTarget.classList.add("active");
    if(id === "tab-days") renderDays();
  }

  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function anyNC(p1,p2,fa,p3){
    return [p1,p2,fa,p3].some(x => x === "NC");
  }

  function syncNcPanel(){
    const p1 = document.getElementById("in-p1").value;
    const p2 = document.getElementById("in-p2").value;
    const fa = document.getElementById("in-fa").value;
    const p3 = document.getElementById("in-p3").value;
    document.getElementById("nc-panel").style.display = anyNC(p1,p2,fa,p3) ? "block" : "none";
  }

  function fillHeaderFields(){
    document.getElementById("in-fecha").value = current.fecha || "";
    document.getElementById("in-animales").value = current.animales || "";
    document.getElementById("in-resp").value = current.resp || "";
    document.getElementById("in-obs").value = current.obs || "";
  }

  function readHeaderFields(){
    current.fecha = document.getElementById("in-fecha").value || "";
    current.animales = document.getElementById("in-animales").value || "";
    current.resp = (document.getElementById("in-resp").value || "").toUpperCase();
    current.obs = document.getElementById("in-obs").value || "";
  }

  function limpiarCarga(){
    document.getElementById("in-garron").value = "";
    document.getElementById("in-p1").value = "";
    document.getElementById("in-p2").value = "";
    document.getElementById("in-fa").value = "";
    document.getElementById("in-p3").value = "";
    document.getElementById("in-nc").value = "";
    document.getElementById("in-ac").value = "";
    document.getElementById("in-ap").value = "";
    document.getElementById("in-enc").value = "";
    syncNcPanel();
  }

  // ✅ Validación: no deja agregar si P1/P2/FA/P3 están sin elegir
  function validatePicks(){
    const p1 = document.getElementById("in-p1").value;
    const p2 = document.getElementById("in-p2").value;
    const fa = document.getElementById("in-fa").value;
    const p3 = document.getElementById("in-p3").value;
    if(!p1 || !p2 || !fa || !p3){
      alert("Falta seleccionar P1, P2, FA y P3 (A o NC).");
      return null;
    }
    return {p1,p2,fa,p3};
  }

  function agregarRegistro(){
    if(!current) nuevoDia();
    readHeaderFields();

    const g = (document.getElementById("in-garron").value || "").trim();
    if(!g){
      alert("Falta Garrón.");
      return;
    }

    const picks = validatePicks();
    if(!picks) return;

    const {p1,p2,fa,p3} = picks;

    const row = {
      id: uid(),
      garron: g,
      p1, p2, fa, p3,
      nc: anyNC(p1,p2,fa,p3) ? (document.getElementById("in-nc").value || "") : "",
      ac: anyNC(p1,p2,fa,p3) ? (document.getElementById("in-ac").value || "") : "",
      ap: anyNC(p1,p2,fa,p3) ? (document.getElementById("in-ap").value || "") : "",
      enc: anyNC(p1,p2,fa,p3) ? (document.getElementById("in-enc").value || "") : ""
    };

    current.rows.push(row);
    saveCurrent();
    renderTable();
    limpiarCarga();
  }

  function renderTable(){
    const tb = document.getElementById("tbody");
    const rows = (current?.rows || []).slice().sort((a,b)=> Number(a.garron) - Number(b.garron));

    const pill = (v)=>{
      if(v === "NC") return `<span class="pill-nc">NC</span>`;
      if(v === "A") return `<span class="pill-a">A</span>`;
      return `<span class="pill-na">—</span>`;
    };

    tb.innerHTML = rows.map(r=>`
      <tr>
        <td><b>${esc(r.garron)}</b></td>
        <td>${pill(r.p1)}</td>
        <td>${pill(r.p2)}</td>
        <td>${pill(r.fa)}</td>
        <td>${pill(r.p3)}</td>
        <td class="no-print">
          <button class="mini-btn gray" onclick="editarFila('${r.id}')">Editar</button>
          <button class="mini-btn danger" onclick="borrarFila('${r.id}')">Borrar</button>
        </td>
      </tr>
    `).join("");

    if(rows.length === 0){
      tb.innerHTML = `<tr><td colspan="6" style="color:var(--muted);">Sin registros todavía.</td></tr>`;
    }
  }

  function borrarFila(id){
    if(!current) return;
    if(!confirm("¿Borrar esta fila?")) return;
    current.rows = current.rows.filter(r => r.id !== id);
    saveCurrent();
    renderTable();
  }

  function editarFila(id){
    if(!current) return;
    const r = current.rows.find(x=>x.id===id);
    if(!r) return;

    document.getElementById("in-garron").value = r.garron;
    document.getElementById("in-p1").value = r.p1 || "";
    document.getElementById("in-p2").value = r.p2 || "";
    document.getElementById("in-fa").value = r.fa || "";
    document.getElementById("in-p3").value = r.p3 || "";

    document.getElementById("in-nc").value = r.nc || "";
    document.getElementById("in-ac").value = r.ac || "";
    document.getElementById("in-ap").value = r.ap || "";
    document.getElementById("in-enc").value = r.enc || "";

    syncNcPanel();

    if(confirm("Editar esta fila: OK = se reemplaza cuando vuelvas a tocar AGREGAR.")){
      current.rows = current.rows.filter(x=>x.id!==id);
      saveCurrent();
      renderTable();
    }
  }

  function nuevoDia(){
    current = {
      id: uid(),
      fecha: "",
      animales: "Todos los animales que integran la faena Kosher del día",
      resp: "",
      obs: "",
      rows: [],
      finalized: false
    };
    saveCurrent();
    fillHeaderFields();
    renderTable();
    limpiarCarga();

    // enganchar change listeners (una vez)
    ["in-p1","in-p2","in-fa","in-p3"].forEach(id=>{
      const el = document.getElementById(id);
      if(el && !el.dataset.bound){
        el.addEventListener("change", syncNcPanel);
        el.dataset.bound = "1";
      }
    });
  }

  function borrarDiaActual(){
    if(!current) return;
    if(!confirm("¿Borrar el día actual (lo que estás cargando)?")) return;
    localStorage.removeItem(LS_CURR);
    current = null;
    nuevoDia();
  }

  function finalizarDia(){
    if(!current) return;
    readHeaderFields();

    if(!current.fecha){
      alert("Falta la fecha de faena.");
      return;
    }
    if(current.rows.length === 0){
      alert("No hay registros cargados.");
      return;
    }

    const days = loadDays();
    current.finalized = true;

    const idx = days.findIndex(d => d.id === current.id);
    if(idx >= 0) days[idx] = current;
    else days.unshift(current);

    saveDays(days);
    alert("Día finalizado y guardado ✅");
  }

  function renderDays(){
    const days = loadDays();
    const body = document.getElementById("daysBody");

    body.innerHTML = days.map(d => `
      <tr>
        <td><b>${esc(d.fecha)}</b></td>
        <td>${(d.rows||[]).length}</td>
        <td>${esc(d.resp || "")}</td>
        <td>${esc(d.obs || "")}</td>
        <td class="no-print">
          <button class="mini-btn primary" onclick="reabrirDia('${d.id}')">Editar</button>
          <button class="mini-btn gray" onclick="imprimirDia('${d.id}')">PDF</button>
          <button class="mini-btn danger" onclick="borrarDia('${d.id}')">Borrar</button>
        </td>
      </tr>
    `).join("");

    if(days.length === 0){
      body.innerHTML = `<tr><td colspan="5" style="color:var(--muted);">Todavía no hay días finalizados.</td></tr>`;
    }
  }

  function reabrirDia(id){
    const days = loadDays();
    const d = days.find(x => x.id === id);
    if(!d) return;
    current = d;
    current.finalized = false;
    saveCurrent();
    fillHeaderFields();
    renderTable();
    limpiarCarga();

    document.querySelectorAll(".tab-content").forEach(x => x.classList.remove("active"));
    document.getElementById("tab-reg").classList.add("active");
    document.querySelectorAll(".tab-btn").forEach(x => x.classList.remove("active"));
    document.querySelectorAll(".tab-btn")[0].classList.add("active");
  }

  function borrarDia(id){
    if(!confirm("¿Borrar este día guardado?")) return;
    let days = loadDays();
    days = days.filter(d => d.id !== id);
    saveDays(days);
    renderDays();
  }

  function imprimirDiaActual(){
    if(!current) return;
    readHeaderFields();
    if(!current.fecha){ alert("Falta fecha de faena."); return; }
    if(current.rows.length === 0){ alert("No hay registros cargados."); return; }
    printObject(current);
  }

  function imprimirDia(id){
    const days = loadDays();
    const d = days.find(x => x.id === id);
    if(!d) return;
    printObject(d);
  }

  function printObject(d){
    const rows = (d.rows || []).slice().sort((a,b)=> Number(a.garron) - Number(b.garron));
    const ncRows = rows.filter(r => anyNC(r.p1,r.p2,r.fa,r.p3));
    const pillText = (v)=> (v || "—");

    const html = `
      <div class="print-page">
        <div class="encabezado">
          <table>
            <tr>
              <td class="logo">
                <img src="logo.jpg" onerror="this.onerror=null; this.src='logo.png';" alt="Logo">
              </td>
              <td class="titulo">
                <div><strong>CHECK LIST</strong></div>
                <div><strong>BIENESTAR ANIMAL EN FAENA KOSHER</strong></div>
                <div><strong>ISRAEL</strong></div>
                <div style="margin-top:4px; color:#0b3d91; font-weight:900;">Circular 4170 A | R-BA-001-6</div>
              </td>
              <td class="info">Emisión: Junio / 2024<br>Rev: 03</td>
            </tr>
          </table>
        </div>

        <div style="margin-top:10px; font-size:13px;">
          <div><b>Fecha de faena:</b> ${esc(d.fecha)}</div>
          <div><b>Animales a revisar:</b> ${esc(d.animales || "")}</div>
          <div><b>Responsable:</b> ${esc(d.resp || "")}</div>
          ${d.obs ? `<div><b>Obs:</b> ${esc(d.obs)}</div>` : ``}
          <div style="margin-top:8px; font-weight:900;">REGISTRO</div>
        </div>

        <table style="width:100%; border-collapse:collapse; margin-top:8px;">
          <thead>
            <tr>
              <th style="border:1px solid #000; padding:6px;">Garrón</th>
              <th style="border:1px solid #000; padding:6px;">P1</th>
              <th style="border:1px solid #000; padding:6px;">P2</th>
              <th style="border:1px solid #000; padding:6px;">FA</th>
              <th style="border:1px solid #000; padding:6px;">P3</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r=>`
              <tr>
                <td style="border:1px solid #000; padding:6px;">${esc(r.garron)}</td>
                <td style="border:1px solid #000; padding:6px;">${pillText(r.p1)}</td>
                <td style="border:1px solid #000; padding:6px;">${pillText(r.p2)}</td>
                <td style="border:1px solid #000; padding:6px;">${pillText(r.fa)}</td>
                <td style="border:1px solid #000; padding:6px;">${pillText(r.p3)}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>

        ${ncRows.length ? `
          <div style="margin-top:14px; font-weight:900;">NO CONFORMIDADES / ACCIONES</div>
          <table style="width:100%; border-collapse:collapse; margin-top:8px;">
            <thead>
              <tr>
                <th style="border:1px solid #000; padding:6px;">Garrón</th>
                <th style="border:1px solid #000; padding:6px;">Detalle NC</th>
                <th style="border:1px solid #000; padding:6px;">Acción correctiva</th>
                <th style="border:1px solid #000; padding:6px;">Acción preventiva</th>
                <th style="border:1px solid #000; padding:6px;">Encargado</th>
              </tr>
            </thead>
            <tbody>
              ${ncRows.map(r=>`
                <tr>
                  <td style="border:1px solid #000; padding:6px;">${esc(r.garron)}</td>
                  <td style="border:1px solid #000; padding:6px;">${esc(r.nc || "")}</td>
                  <td style="border:1px solid #000; padding:6px;">${esc(r.ac || "")}</td>
                  <td style="border:1px solid #000; padding:6px;">${esc(r.ap || "")}</td>
                  <td style="border:1px solid #000; padding:6px;">${esc(r.enc || "")}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        ` : ``}

        <div class="sign">
          <div class="line">Analista</div>
          <div class="line">Verificador</div>
        </div>
      </div>
    `;

    const w = window.open("", "_blank");
    w.document.write(`
      <html>
      <head>
        <meta charset="UTF-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <title>PDF Bienestar Animal</title>
        <style>
          body{ font-family: Arial, sans-serif; margin:0; padding:0; }
          .encabezado table{ width:100%; border-collapse: collapse; }
          .encabezado td{ border:2px solid #000; padding:8px; vertical-align:middle; }
          .encabezado .logo{ width:20%; text-align:center; }
          .encabezado .logo img{ width:110px; max-width:100%; height:auto; }
          .encabezado .titulo{ width:60%; text-align:center; font-size:13px; line-height:1.25; }
          .encabezado .info{ width:20%; text-align:center; font-size:12px; background:#dff3ff; line-height:1.25; }
          .print-page{ padding: 8mm; }
          .sign{ margin-top:16px; display:flex; justify-content:space-between; gap:18px; }
          .line{ flex:1; border-top: 2px solid #000; padding-top:6px; text-align:center; font-weight:800; }
          @page { margin: 10mm; }
        </style>
      </head>
      <body>
        ${html}
        <script>window.onload = () => { window.print(); }<\/script>
      </body>
      </html>
    `);
    w.document.close();
  }

  window.onload = () => {
    current = loadCurrent();
    if(!current){
      nuevoDia();
    } else {
      fillHeaderFields();
      renderTable();
      limpiarCarga();
    }

    ["in-p1","in-p2","in-fa","in-p3"].forEach(id=>{
      const el = document.getElementById(id);
      if(el && !el.dataset.bound){
        el.addEventListener("change", syncNcPanel);
        el.dataset.bound = "1";
      }
    });

    syncNcPanel();
  };
</script>

</body>
</html>