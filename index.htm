<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Check List Bienestar Animal - Kosher</title>

<style>
  :root{
    --bg:#eef2f7;
    --card:#ffffff;
    --text:#111827;
    --muted:#6b7280;
    --border:#e5e7eb;
    --primary:#2563eb;
    --primary2:#1d4ed8;
    --green:#16a34a;
    --red:#ef4444;
    --graybtn:#64748b;
    --shadow: 0 6px 22px rgba(15,23,42,.08);
    --radius: 16px;
  }
  *{ box-sizing:border-box; }
  body{ margin:0; font-family: Arial, sans-serif; background:var(--bg); color:var(--text); }
  .wrap{ max-width: 1400px; margin:0 auto; padding:12px; }

  /* Header */
  .head{
    background:#fff;
    border:2px solid #000;
    display:grid;
    grid-template-columns: 220px 1fr 260px;
    align-items:center;
    gap:10px;
    padding:10px;
  }
  .logoBox{
    border:2px solid #000;
    height:92px;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    padding:6px;
  }
  .logoBox img{ max-height:72px; max-width:200px; object-fit:contain; }
  .titleBox{
    border:2px solid #000;
    height:92px;
    display:flex;
    align-items:center;
    justify-content:center;
    text-align:center;
    padding:8px;
    line-height:1.25;
    font-weight:800;
  }
  .titleBox small{ display:block; font-weight:700; color:#0b3d91; margin-top:6px; }
  .infoBox{
    border:2px solid #000;
    height:92px;
    background:#dff3ff;
    padding:10px;
    font-size:12px;
    line-height:1.35;
    font-weight:700;
  }

  /* Tabs */
  .tabs{
    margin-top:10px;
    display:grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap:10px;
  }
  .tabBtn{
    height:46px;
    border:none;
    border-radius:12px;
    background:#cbd5e1;
    cursor:pointer;
    font-weight:900;
    color:#0f172a;
  }
  .tabBtn.active{
    background:var(--primary);
    color:#fff;
  }

  /* Toolbar */
  .toolbar{
    margin-top:10px;
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:10px;
    display:grid;
    grid-template-columns: 220px 220px 220px 220px 220px 220px;
    gap:10px;
    box-shadow: var(--shadow);
  }
  @media (max-width: 1200px){
    .toolbar{ grid-template-columns: repeat(2, 1fr); }
  }
  .btn{
    height:48px;
    border:none;
    border-radius:12px;
    cursor:pointer;
    font-weight:900;
    color:#fff;
    background:var(--primary);
  }
  .btn:hover{ background:var(--primary2); }
  .btn.gray{ background: var(--graybtn); }
  .btn.green{ background: var(--green); }
  .btn.red{ background: var(--red); }

  /* Cards */
  .card{
    margin-top:10px;
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:12px;
    box-shadow: var(--shadow);
  }
  .grid2{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
  }
  .field{
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  label{
    font-size:11px;
    font-weight:900;
    color:var(--muted);
    text-transform:uppercase;
  }
  input, select, textarea{
    border:1px solid var(--border);
    background:#f8fafc;
    color:var(--text);
    border-radius:12px;
    padding:12px;
    font-size:15px;
    outline:none;
  }
  textarea{ min-height:48px; resize:vertical; }

  .actionsRow{
    margin-top:10px;
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
  }
  .btnBig{
    height:52px;
    border:none;
    border-radius:12px;
    cursor:pointer;
    font-weight:900;
    color:#fff;
  }
  .btnBig.blue{ background:#0ea5e9; }
  .btnBig.green{ background: var(--green); }

  .hint{
    margin-top:8px;
    font-size:12px;
    color:#334155;
    font-weight:700;
  }
  .hint b{ color:#0f172a; }

  /* Table */
  .tableWrap{
    margin-top:10px;
    background:#fff;
    border:1px solid var(--border);
    border-radius:var(--radius);
    overflow:auto;
    box-shadow: var(--shadow);
  }
  table{ width:100%; border-collapse:collapse; min-width: 980px; }
  th, td{
    border-bottom:1px solid var(--border);
    padding:10px;
    font-size:14px;
    vertical-align:top;
  }
  th{ background:#f1f5f9; position:sticky; top:0; z-index:2; }
  .colG{ width:90px; }
  .colP{ width:110px; }
  .colObs{ min-width:340px; }

  .pill{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    min-width:34px;
    height:24px;
    border-radius:999px;
    font-weight:900;
    font-size:12px;
    padding:0 10px;
  }
  .pillA{ background:#dcfce7; color:#065f46; }
  .pillNC{ background:#fee2e2; color:#7f1d1d; }
  .pillEmpty{ background:#e2e8f0; color:#0f172a; }

  .miniRow{
    display:flex; gap:10px; align-items:center; flex-wrap:wrap;
  }
  .miniBtn{
    border:none; border-radius:10px;
    padding:10px 12px;
    cursor:pointer;
    font-weight:900;
  }
  .miniBtn.gray{ background:#e2e8f0; color:#0f172a; }
  .miniBtn.red{ background: var(--red); color:#fff; }

  /* Tabs content */
  .tab{ display:none; }
  .tab.active{ display:block; }

  /* Print */
  @media print{
    .tabs, .toolbar, .noPrint { display:none !important; }
    body{ background:#fff; }
    .card, .tableWrap{ box-shadow:none; }
    th{ position:static; }
    @page{ margin:10mm; }
  }
</style>
</head>

<body>
<div class="wrap">

  <div class="head">
    <div class="logoBox">
      <img src="logo.jpg" onerror="this.onerror=null; this.src='logo.png';" alt="Logo">
    </div>

    <div class="titleBox">
      <div>
        CHECK LIST<br>
        BIENESTAR ANIMAL EN FAENA KOSHER<br>
        <span style="font-weight:900;">ISRAEL</span>
        <small>Circular: 4170 A &nbsp; | &nbsp; Código: R-BA-001-6</small>
      </div>
    </div>

    <div class="infoBox">
      Circular: 4170 A<br>
      Código: R-BA-001-6<br>
      Emisión: Junio / 2024<br>
      Rev: 03
    </div>
  </div>

  <div class="tabs">
    <button class="tabBtn active" id="btn-check" onclick="openTab('check')">CHECKLIST</button>
    <button class="tabBtn" id="btn-resumen" onclick="openTab('resumen')">RESUMEN / NC</button>
    <button class="tabBtn" id="btn-days" onclick="openTab('days')">DÍAS FINALIZADOS</button>
  </div>

  <div class="toolbar noPrint">
    <button class="btn gray" onclick="toggleTema()">TEMA</button>
    <button class="btn" onclick="imprimir()">PDF (IMPRIMIR)</button>
    <button class="btn" onclick="descargarRespaldo()">DESCARGAR RESPALDO</button>
    <button class="btn" onclick="importarRespaldo()">IMPORTAR RESPALDO</button>
    <button class="btn green" onclick="finalizarDia()">FINALIZAR DÍA</button>
    <button class="btn red" onclick="borrarDia()">BORRAR DÍA</button>
  </div>

  <!-- TAB CHECKLIST -->
  <div id="tab-check" class="tab active">

    <div class="card">
      <div class="grid2">
        <div class="field">
          <label>Fecha de faena</label>
          <input type="date" id="in-fecha">
        </div>
        <div class="field">
          <label>Rango de garrón (inicio)</label>
          <input type="text" id="in-rango" placeholder="Ej: 1-50 ó 1" value="1-50">
        </div>
      </div>

      <div class="actionsRow noPrint">
        <button class="btnBig blue" onclick="cargar100()">CARGAR 100 GARRONES (planilla)</button>
        <button class="btnBig green" onclick="agregarUno()">+1 GARRÓN</button>
      </div>

      <div class="hint">
        <b>P1:</b> Tiempo contención–degüello ≤ 10 seg |
        <b>P2:</b> Liberación accionamientos sujeción post degüello |
        <b>FA:</b> Falso aneurisma |
        <b>P3:</b> Liberación del animal del cajón rotatorio<br>
        Referencias: <b>A</b> = Aceptable · <b>NC</b> = No conforme · <b>—</b> = sin seleccionar
      </div>
    </div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th class="colG">GARRÓN</th>
            <th class="colP">P1</th>
            <th class="colP">P2</th>
            <th class="colP">FA</th>
            <th class="colP">P3</th>
            <th class="colObs">OBSERVACIONES</th>
            <th class="noPrint">ACCIONES</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="card">
      <div style="font-weight:900; margin-bottom:6px;">CIERRE DEL REGISTRO</div>
      <div class="grid2">
        <div class="field">
          <label>Inspector</label>
          <input type="text" id="in-inspector" placeholder="Nombre / Iniciales">
        </div>
        <div class="field">
          <label>Verificación</label>
          <input type="text" id="in-verif" placeholder="Nombre / Iniciales">
        </div>
      </div>
    </div>

  </div>

  <!-- TAB RESUMEN -->
  <div id="tab-resumen" class="tab">
    <div class="card">
      <div style="font-weight:900; font-size:16px;">RESUMEN DEL DÍA</div>
      <div style="color:var(--muted); margin-top:4px; font-weight:700;">
        Se calcula en base a filas con P1/P2/FA/P3 seleccionados (A o NC).
      </div>

      <div id="resumenBox" style="margin-top:12px;"></div>
    </div>

    <div class="card">
      <div style="font-weight:900; margin-bottom:6px;">NO CONFORMIDADES (NC)</div>
      <div class="tableWrap" style="box-shadow:none; border:none; margin-top:0;">
        <table>
          <thead>
            <tr>
              <th class="colG">GARRÓN</th>
              <th>P1</th><th>P2</th><th>FA</th><th>P3</th>
              <th>OBSERVACIONES</th>
            </tr>
          </thead>
          <tbody id="ncBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- TAB DÍAS FINALIZADOS -->
  <div id="tab-days" class="tab">
    <div class="card">
      <div style="font-weight:900;">DÍAS FINALIZADOS</div>
      <div style="color:var(--muted); font-weight:700; margin-top:4px;">
        Podés reabrir un día finalizado para corregir o imprimir.
      </div>
    </div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Registros</th>
            <th>Inspector</th>
            <th>Verificación</th>
            <th class="noPrint">Acciones</th>
          </tr>
        </thead>
        <tbody id="daysBody"></tbody>
      </table>
    </div>
  </div>

</div>

<script>
  /* =========================
     STORAGE
  ========================= */
  const LS_CURR = "ba_kosher_current_v4";
  const LS_DAYS = "ba_kosher_days_v4";

  let current = null;

  function uid(){
    return "D" + Date.now().toString(36) + Math.random().toString(36).slice(2,7);
  }

  function loadDays(){
    try{ return JSON.parse(localStorage.getItem(LS_DAYS) || "[]"); }
    catch(e){ return []; }
  }
  function saveDays(days){
    localStorage.setItem(LS_DAYS, JSON.stringify(days));
  }
  function loadCurrent(){
    try{
      const v = localStorage.getItem(LS_CURR);
      return v ? JSON.parse(v) : null;
    }catch(e){ return null; }
  }
  function saveCurrent(){
    localStorage.setItem(LS_CURR, JSON.stringify(current));
  }

  /* =========================
     UI / TABS
  ========================= */
  function openTab(name){
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.querySelectorAll(".tabBtn").forEach(b => b.classList.remove("active"));

    document.getElementById("tab-" + name).classList.add("active");
    document.getElementById("btn-" + name).classList.add("active");

    if(name === "resumen") renderResumen();
    if(name === "days") renderDays();
  }

  function toggleTema(){
    // Alterna un tema simple (claro/oscuro) si querés
    const dark = document.body.dataset.dark === "1";
    document.body.dataset.dark = dark ? "0" : "1";
    if(!dark){
      document.documentElement.style.setProperty("--bg","#0b1220");
      document.documentElement.style.setProperty("--card","#0f172a");
      document.documentElement.style.setProperty("--text","#e5e7eb");
      document.documentElement.style.setProperty("--muted","#94a3b8");
      document.documentElement.style.setProperty("--border","#1f2937");
    }else{
      document.documentElement.style.setProperty("--bg","#eef2f7");
      document.documentElement.style.setProperty("--card","#ffffff");
      document.documentElement.style.setProperty("--text","#111827");
      document.documentElement.style.setProperty("--muted","#6b7280");
      document.documentElement.style.setProperty("--border","#e5e7eb");
    }
  }

  /* =========================
     HELPERS
  ========================= */
  function esc(s){
    s = String(s == null ? "" : s);
    return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
            .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
  }

  function pill(v){
    if(v === "A") return '<span class="pill pillA">A</span>';
    if(v === "NC") return '<span class="pill pillNC">NC</span>';
    return '<span class="pill pillEmpty">—</span>';
  }

  function anyNC(r){
    return [r.p1,r.p2,r.fa,r.p3].some(x => x === "NC");
  }

  function completeRow(r){
    return [r.p1,r.p2,r.fa,r.p3].every(x => x === "A" || x === "NC");
  }

  /* =========================
     CURRENT DAY MODEL
  ========================= */
  function newDay(){
    current = {
      id: uid(),
      fecha: "",
      rango: "1-50",
      inspector: "",
      verif: "",
      rows: [],
      finalized: false
    };
    saveCurrent();
    fillHeader();
    renderTable();
  }

  function fillHeader(){
    document.getElementById("in-fecha").value = current.fecha || "";
    document.getElementById("in-rango").value = current.rango || "1-50";
    document.getElementById("in-inspector").value = current.inspector || "";
    document.getElementById("in-verif").value = current.verif || "";
  }

  function readHeader(){
    current.fecha = document.getElementById("in-fecha").value || "";
    current.rango = document.getElementById("in-rango").value || "";
    current.inspector = (document.getElementById("in-inspector").value || "").trim();
    current.verif = (document.getElementById("in-verif").value || "").trim();
  }

  /* =========================
     ROWS
  ========================= */
  function parseRangoStart(){
    const raw = (document.getElementById("in-rango").value || "").trim();
    // acepta "1-50" o "1"
    const m = raw.match(/^(\d+)\s*(?:-\s*\d+)?$/);
    if(!m) return null;
    return Number(m[1]);
  }

  function ensureUniqueGarron(n){
    return !current.rows.some(r => Number(r.garron) === Number(n));
  }

  function addRow(garron){
    current.rows.push({
      id: uid(),
      garron: Number(garron),
      // IMPORTANTE: NO preseleccionado
      p1: "",
      p2: "",
      fa: "",
      p3: "",
      obs: ""
    });
  }

  function cargar100(){
    if(!current) newDay();
    readHeader();
    const start = parseRangoStart();
    if(start == null){ alert("Rango inválido. Ej: 1-50 o 1"); return; }

    // agrega 100 garrones consecutivos desde start
    let added = 0;
    for(let i=0; i<100; i++){
      const g = start + i;
      if(ensureUniqueGarron(g)){
        addRow(g);
        added++;
      }
    }
    saveCurrent();
    renderTable();
    alert("Listo ✅ Se cargaron " + added + " garrones (sin duplicados).");
  }

  function agregarUno(){
    if(!current) newDay();
    readHeader();
    // elige el mayor garron + 1, o el start si no hay
    const start = parseRangoStart() ?? 1;
    let next = start;

    if(current.rows.length){
      const maxG = Math.max(...current.rows.map(r => Number(r.garron)));
      next = maxG + 1;
    }
    while(!ensureUniqueGarron(next)) next++;
    addRow(next);

    saveCurrent();
    renderTable();
  }

  function borrarFila(id){
    if(!confirm("¿Borrar este garrón?")) return;
    current.rows = current.rows.filter(r => r.id !== id);
    saveCurrent();
    renderTable();
  }

  function updateField(id, key, value){
    const r = current.rows.find(x => x.id === id);
    if(!r) return;
    r[key] = value;
    saveCurrent();
  }

  function renderTable(){
    const tb = document.getElementById("tbody");
    if(!current || !current.rows.length){
      tb.innerHTML = `<tr><td colspan="7" style="color:#64748b; font-weight:700;">Sin registros todavía.</td></tr>`;
      return;
    }

    const rows = current.rows.slice().sort((a,b)=> Number(a.garron)-Number(b.garron));

    tb.innerHTML = rows.map(r => `
      <tr>
        <td><b>${esc(r.garron)}</b></td>

        <td>
          <select onchange="updateField('${r.id}','p1',this.value)">
            <option value="" ${r.p1==="" ? "selected":""}>—</option>
            <option value="A" ${r.p1==="A" ? "selected":""}>A</option>
            <option value="NC" ${r.p1==="NC" ? "selected":""}>NC</option>
          </select>
          <div style="margin-top:6px;">${pill(r.p1)}</div>
        </td>

        <td>
          <select onchange="updateField('${r.id}','p2',this.value)">
            <option value="" ${r.p2==="" ? "selected":""}>—</option>
            <option value="A" ${r.p2==="A" ? "selected":""}>A</option>
            <option value="NC" ${r.p2==="NC" ? "selected":""}>NC</option>
          </select>
          <div style="margin-top:6px;">${pill(r.p2)}</div>
        </td>

        <td>
          <select onchange="updateField('${r.id}','fa',this.value)">
            <option value="" ${r.fa==="" ? "selected":""}>—</option>
            <option value="A" ${r.fa==="A" ? "selected":""}>A</option>
            <option value="NC" ${r.fa==="NC" ? "selected":""}>NC</option>
          </select>
          <div style="margin-top:6px;">${pill(r.fa)}</div>
        </td>

        <td>
          <select onchange="updateField('${r.id}','p3',this.value)">
            <option value="" ${r.p3==="" ? "selected":""}>—</option>
            <option value="A" ${r.p3==="A" ? "selected":""}>A</option>
            <option value="NC" ${r.p3==="NC" ? "selected":""}>NC</option>
          </select>
          <div style="margin-top:6px;">${pill(r.p3)}</div>
        </td>

        <td>
          <textarea placeholder="Opcional" oninput="updateField('${r.id}','obs',this.value)">${esc(r.obs||"")}</textarea>
        </td>

        <td class="noPrint">
          <div class="miniRow">
            <button class="miniBtn red" onclick="borrarFila('${r.id}')">Borrar</button>
          </div>
        </td>
      </tr>
    `).join("");
  }

  /* =========================
     RESUMEN / NC
  ========================= */
  function renderResumen(){
    const box = document.getElementById("resumenBox");
    const ncBody = document.getElementById("ncBody");

    if(!current || !current.rows.length){
      box.innerHTML = `<div style="color:var(--muted); font-weight:800;">Sin registros cargados.</div>`;
      ncBody.innerHTML = `<tr><td colspan="6" style="color:var(--muted); font-weight:800;">Sin NC.</td></tr>`;
      return;
    }

    const rows = current.rows.slice().sort((a,b)=> Number(a.garron)-Number(b.garron));
    const evalRows = rows.filter(completeRow); // solo filas completas

    const total = evalRows.length;
    const countField = (k, val) => evalRows.filter(r => r[k] === val).length;

    const p1A = countField("p1","A"), p1NC = countField("p1","NC");
    const p2A = countField("p2","A"), p2NC = countField("p2","NC");
    const faA = countField("fa","A"), faNC = countField("fa","NC");
    const p3A = countField("p3","A"), p3NC = countField("p3","NC");

    const anyNcCount = evalRows.filter(anyNC).length;

    const pct = (n) => total ? Math.round((n/total)*100) : 0;

    box.innerHTML = `
      <div class="tableWrap" style="box-shadow:none; border:none;">
        <table>
          <thead>
            <tr>
              <th>Ítem</th>
              <th>Total evaluado</th>
              <th>A</th>
              <th>NC</th>
              <th>% NC</th>
            </tr>
          </thead>
          <tbody>
            <tr><td><b>P1</b></td><td>${total}</td><td>${p1A}</td><td>${p1NC}</td><td><b>${pct(p1NC)}%</b></td></tr>
            <tr><td><b>P2</b></td><td>${total}</td><td>${p2A}</td><td>${p2NC}</td><td><b>${pct(p2NC)}%</b></td></tr>
            <tr><td><b>FA</b></td><td>${total}</td><td>${faA}</td><td>${faNC}</td><td><b>${pct(faNC)}%</b></td></tr>
            <tr><td><b>P3</b></td><td>${total}</td><td>${p3A}</td><td>${p3NC}</td><td><b>${pct(p3NC)}%</b></td></tr>
            <tr>
              <td><b>Filas con alguna NC</b></td>
              <td>${total}</td>
              <td>—</td>
              <td>${anyNcCount}</td>
              <td><b>${pct(anyNcCount)}%</b></td>
            </tr>
          </tbody>
        </table>
      </div>
      <div style="margin-top:10px; color:var(--muted); font-weight:800;">
        Nota: Solo cuentan filas con P1/P2/FA/P3 seleccionados (A o NC).
      </div>
    `;

    const ncRows = evalRows.filter(anyNC);
    if(!ncRows.length){
      ncBody.innerHTML = `<tr><td colspan="6" style="color:var(--muted); font-weight:800;">Sin NC.</td></tr>`;
      return;
    }

    ncBody.innerHTML = ncRows.map(r => `
      <tr>
        <td><b>${esc(r.garron)}</b></td>
        <td>${pill(r.p1)}</td>
        <td>${pill(r.p2)}</td>
        <td>${pill(r.fa)}</td>
        <td>${pill(r.p3)}</td>
        <td>${esc(r.obs || "")}</td>
      </tr>
    `).join("");
  }

  /* =========================
     FINALIZAR / BORRAR / PRINT
  ========================= */
  function finalizarDia(){
    if(!current) return;
    readHeader();
    if(!current.fecha){ alert("Falta Fecha de faena."); return; }
    if(!current.rows.length){ alert("No hay garrones cargados."); return; }

    // Recomendación: exigir que al menos haya 1 fila completa
    const evalRows = current.rows.filter(completeRow);
    if(!evalRows.length){
      if(!confirm("No hay filas completas (P1/P2/FA/P3). ¿Finalizar igual?")) return;
    }

    const days = loadDays();
    current.finalized = true;

    // reemplaza si existe
    const idx = days.findIndex(d => d.id === current.id);
    if(idx >= 0) days[idx] = current;
    else days.unshift(current);

    saveDays(days);
    saveCurrent();
    alert("Día finalizado y guardado ✅");
    openTab("days");
  }

  function borrarDia(){
    if(!confirm("¿Borrar el día actual (todo lo cargado)?")) return;
    localStorage.removeItem(LS_CURR);
    newDay();
    alert("Día borrado ✅");
  }

  function imprimir(){
    readHeader();
    if(!current.fecha){ alert("Falta Fecha de faena."); return; }
    window.print();
  }

  /* =========================
     DIAS FINALIZADOS
  ========================= */
  function renderDays(){
    const body = document.getElementById("daysBody");
    const days = loadDays();

    if(!days.length){
      body.innerHTML = `<tr><td colspan="5" style="color:var(--muted); font-weight:800;">Todavía no hay días finalizados.</td></tr>`;
      return;
    }

    body.innerHTML = days.map(d => `
      <tr>
        <td><b>${esc(d.fecha || "")}</b></td>
        <td>${(d.rows||[]).length}</td>
        <td>${esc(d.inspector || "")}</td>
        <td>${esc(d.verif || "")}</td>
        <td class="noPrint">
          <div class="miniRow">
            <button class="miniBtn gray" onclick="reabrirDia('${d.id}')">Editar</button>
            <button class="miniBtn gray" onclick="imprimirDia('${d.id}')">PDF</button>
            <button class="miniBtn red" onclick="borrarDiaGuardado('${d.id}')">Borrar</button>
          </div>
        </td>
      </tr>
    `).join("");
  }

  function reabrirDia(id){
    const days = loadDays();
    const d = days.find(x => x.id === id);
    if(!d) return;
    current = d;
    current.finalized = false;
    saveCurrent();
    fillHeader();
    renderTable();
    openTab("check");
  }

  function borrarDiaGuardado(id){
    if(!confirm("¿Borrar este día finalizado?")) return;
    let days = loadDays();
    days = days.filter(d => d.id !== id);
    saveDays(days);
    renderDays();
  }

  function imprimirDia(id){
    const days = loadDays();
    const d = days.find(x => x.id === id);
    if(!d) return;

    // Temporariamente setea current para imprimir igual pantalla (simple y efectivo)
    const backup = current;
    current = d;
    fillHeader();
    renderTable();
    openTab("check");
    setTimeout(() => {
      window.print();
      // volver
      current = backup;
      fillHeader();
      renderTable();
    }, 300);
  }

  /* =========================
     RESPALDO JSON
  ========================= */
  function descargarRespaldo(){
    const payload = {
      exportedAt: new Date().toISOString(),
      current: loadCurrent(),
      days: loadDays()
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "respaldo_bienestar_animal.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function importarRespaldo(){
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "application/json";
    input.onchange = async () => {
      const file = input.files && input.files[0];
      if(!file) return;
      try{
        const txt = await file.text();
        const data = JSON.parse(txt);

        if(data.days) saveDays(data.days);
        if(data.current){
          localStorage.setItem(LS_CURR, JSON.stringify(data.current));
          current = data.current;
        }else{
          current = loadCurrent();
        }

        if(!current) newDay();
        fillHeader();
        renderTable();

        alert("Respaldo importado ✅");
      }catch(e){
        alert("No se pudo importar. Archivo inválido.");
      }
    };
    input.click();
  }

  /* =========================
     INIT
  ========================= */
  window.onload = function(){
    current = loadCurrent();
    if(!current) newDay();
    else{
      fillHeader();
      renderTable();
    }
  };
</script>

</body>
</html>